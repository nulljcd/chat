<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html {
      height: 100%;
    }

    @font-face {
      font-family: "font";
      src: url("font.ttf");
    }

    body {
      background: #1f1c23;
      margin: 0;
      height: 100%;
    }

    #input {
      background: #1f1c23;
      color: #a198a9;
      margin: 0;
      padding: 0;
      border: 0;
      outline: 0;
      width: 100%;
      resize: none;
      display: block;
      border-top: 2px solid #a198a9;
      height: 28px;
      font-family: Monospace;
      font-size: 10px;
      font-family: font;
    }

    #chatContainer {
      height: calc(100% - 30px);
      width: 100%;
      overflow-y: scroll;
    }

    .message {
      color: #a198a9;
      font-family: Monospace;
      font-size: 10px;
      font-family: font;
      padding-bottom: 10px;
    }
  </style>
</head>

<body>
  <div id="chatContainer">
    <div id="chat"></div>
  </div>
  <textarea id="input"></textarea>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import { getDatabase, ref, set, update, onDisconnect, remove, onChildAdded, onChildRemoved, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

    let firebaseConfig = {
      apiKey: "AIzaSyDBKLagVjAqJymEkLMKaJvfbep_TUPD9S0",
      authDomain: "project-7461927070501805311.firebaseapp.com",
      databaseURL: "https://project-7461927070501805311-default-rtdb.firebaseio.com",
      projectId: "project-7461927070501805311",
      storageBucket: "project-7461927070501805311.appspot.com",
      messagingSenderId: "117048132520",
      appId: "1:117048132520:web:62f45feb23dede3aae939d"
    };

    let app = initializeApp(firebaseConfig);
    let database = getDatabase(app);
    let auth = getAuth();

    let usersRef;
    let userId, userRef, userName;
    let lastUsersData = {};

    signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      if (user) {
        usersRef = ref(database, "users");

        userId = user.uid;
        userRef = ref(database, `users/${userId}`);
        userName = `user${Math.floor(Math.random() * 10)}${Math.floor(Math.random() * 10)}${Math.floor(Math.random() * 10)}`;
        set(userRef, {
          id: userId,
          name: userName,
          message: "",
          sendFlag: false
        });
        onDisconnect(userRef).remove();

        onChildAdded(usersRef, (snapshot) => {
          let userData = snapshot.val();
          pushMessage(`-> ${userData.name}`);
          lastUsersData[userData.id] = userData;
        });
        onChildRemoved(usersRef, (snapshot) => {
          let userData = snapshot.val();
          pushMessage(`<- ${userData.name}`);
          delete lastUsersData[userData.id];
        });
        onValue(usersRef, (snapshot) => {
          let usersData = snapshot.val();
          for (let key in usersData) {
            let userData = usersData[key];
            if (lastUsersData[key].sendFlag != userData.sendFlag) {
              pushMessage(`${userData.name} -> ${userData.message}`);
              lastUsersData[key] = userData;
              break;
            }
          }
        });

        window.onkeydown = e => {
          document.querySelector('#input').focus();
          if (e.code == "Enter") {
            e.preventDefault();

            if (lastUsersData[userId] == null)
              set(userRef, {
                id: userId,
                name: userName,
                message: "",
                sendFlag: false
              });

            let input = document.querySelector("#input").value;
            if (input.length > 0) {
              if (input[0] != "/")
                update(userRef, {
                  message: input,
                  sendFlag: !lastUsersData[userId].sendFlag
                });
              else {
                let command = input.substring(1).split(" ");

                switch (command[0]) {
                  case "help":
                    pushMessage(`commands:
                      clear chat: /clear
                      list all users: /users
                      change name: /name {name}`);
                    break;
                  case "clear":
                    document.querySelector("#chat").innerHTML = "";
                    break;
                  case "users":
                    for (let key in lastUsersData)
                      pushMessage(`-> ${lastUsersData[key].name}`);
                    break;
                  case "name":
                    if (command[1] != null && command[1].length > 1) {
                      userName = command[1];
                      update(userRef, {
                        name: userName
                      });
                      pushMessage(`changed name to: ${userName}`);
                      break;
                    }
                  default:
                    update(userRef, {
                      message: input,
                      sendFlag: !lastUsersData[userId].sendFlag
                    });
                    break;
                }
              }
              document.querySelector("#input").value = "";
            }
          }
        };
      }
    });

    function pushMessage(input) {
      let message = document.createElement("div");
      message.className = "message";
      message.innerText = input;
      document.querySelector("#chat").appendChild(message);
      document.querySelector("#chat").scrollIntoView({
        block: "end"
      });
    }
  </script>
</body>

</html>
