<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html {
      height: 100%;
    }

    @font-face {
      font-family: 'font';
      src: url('pico-8-mono-upper.ttf');
    }

    body {
      background: #1f1c23;
      margin: 0;
      height: 100%;
    }

    #input {
      background: #1f1c23;
      color: #a198a9;
      margin: 0;
      padding: 0;
      border: 0;
      outline: 0;
      width: 100%;
      resize: none;
      display: block;
      border-top: 2px solid #a198a9;
      height: 28px;
      font-family: Monospace;
      font-size: 16px;
      font-family: font;
      line-height: 24px;
    }

    #chatContainer {
      height: calc(100% - 30px);
      width: 100%;
      overflow-y: scroll;
    }

    .message {
      color: #a198a9;
      padding: 15px;
      font-family: Monospace;
      font-size: 16px;
      font-family: font;
      line-height: 24px;
    }
  </style>
</head>

<body>
  <div id="chatContainer">
    <div id="chat"></div>
  </div>
  <textarea id="input"></textarea>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import { getDatabase, ref, set, update, onDisconnect, remove, onValue, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

    let firebaseConfig = {
      apiKey: "AIzaSyDBKLagVjAqJymEkLMKaJvfbep_TUPD9S0",
      authDomain: "project-7461927070501805311.firebaseapp.com",
      databaseURL: "https://project-7461927070501805311-default-rtdb.firebaseio.com",
      projectId: "project-7461927070501805311",
      storageBucket: "project-7461927070501805311.appspot.com",
      messagingSenderId: "117048132520",
      appId: "1:117048132520:web:62f45feb23dede3aae939d"
    };

    let app = initializeApp(firebaseConfig);
    let database = getDatabase(app);
    let auth = getAuth();

    let userId, userRef, usersRef;

    onAuthStateChanged(auth, user => {
      if (user) {
        usersRef = ref(database, `users`);

        userId = user.uid;
        userRef = ref(database, `users/${userId}`);

        set(userRef, {
          id: userId,
          message: "",
          isSender: false
        });

        onDisconnect(userRef).remove();

        onChildAdded(usersRef, (snapshot) => {
          let userData = snapshot.val();

          let message = document.createElement("div");
          message.className = "message";
          if (userData.id == userId)
            message.innerText = `-> ${userData.id.slice(0, 6)} (You)`;
          else
            message.innerText = `-> ${userData.id.slice(0, 6)}`;
          document.querySelector("#chat").appendChild(message);
        });

        onChildRemoved(usersRef, (snapshot) => {
          let userData = snapshot.val();

          let message = document.createElement("div");
          message.className = "message";

          if (userData.id == userId) {
            message.innerText = `<- ${userData.id.slice(0, 6)} (You)`;
            set(userRef, {
              id: userId,
              message: "",
              isSender: false
            });
          } else
            message.innerText = `<- ${userData.id.slice(0, 6)}`;

          document.querySelector("#chat").appendChild(message);
        });

        onValue(usersRef, (snapshot) => {
          for (let key in snapshot.val()) {
            let userData = snapshot.val()[key];

            if (userData.isSender) {
              let message = document.createElement("div");
              message.className = "message";

              if (key == userId) {
                message.innerText = `${userData.id.slice(0, 6)} (You) -> ${userData.message}`;

                update(userRef, {
                  isSender: false
                });
              } else
                message.innerText = `${userData.id.slice(0, 6)} -> ${userData.message}`;

              document.querySelector("#chat").appendChild(message);
              document.querySelector("#chat").scrollIntoView({ block: "end" });
            }
          }
        });
      }
      window.onkeydown = e => {
        if (e.code == "Enter") {
          e.preventDefault();

          let input = document.querySelector("#input").value;
          if (input.length > 0) {
            switch (input) {
              case "/clear":
                document.querySelector("#chat").innerHTML = "";
                break;
              default:
                update(userRef, {
                  message: input,
                  isSender: true
                });
                break;
            }
          }

          document.querySelector("#input").value = "";
        }
      };
    });

    signInAnonymously(auth);
  </script>
</body>

</html>
